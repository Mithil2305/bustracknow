rules_version = '2';

service cloud.firestore {
match /databases/{database}/documents {

// Helper function to check if user is authenticated
function isAuthenticated() {
  return request.auth != null;
}

// Helper function to check if user is admin
// This assumes a custom claim 'admin' is set on the token OR 
// there is a field 'role' in the user document (fetching user doc in rules costs a read operation)
// For simplicity/cost, we often rely on user ID match or custom claims.
// Here we check the user document for a 'role' field.
function isAdmin() {
  return isAuthenticated() && 
    get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
}

// --- Users Collection ---
match /users/{userId} {
  // Users can read and write their own profile
  allow read, write: if isAuthenticated() && request.auth.uid == userId;
  // Admins can read/write any user
  allow read, write: if isAdmin();
}

// --- Routes Collection ---
match /routes/{routeId} {
  // Publicly readable
  allow read: if true;
  // Only admins can modify routes
  allow create, update, delete: if isAdmin();
}

// --- Stops Collection ---
match /stops/{stopId} {
  // Publicly readable
  allow read: if true;
  // Only admins can modify stops
  allow create, update, delete: if isAdmin();
}

// --- Contributions / Reports ---
match /contributions/{contributionId} {
  // Authenticated users can create contributions (e.g., "Bus is full")
  allow create: if isAuthenticated();
  // Users can only read their own contributions or if admin
  allow read: if isAuthenticated() && (request.auth.uid == resource.data.userId || isAdmin());
  // No updates allowed after creation (append-only log)
  allow update: if false;
}

// --- Default Deny ---
match /{document=**} {
  allow read, write: if false;
}


}
}