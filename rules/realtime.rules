// rules/realtime.rules
{
  "rules": {
    "active_buses": {
      "$routeId": {
        "$sessionId": {
          // ðŸ”’ CRITICAL: Only session owner or admin can write
          ".write": "auth != null && (
            (data.exists() && data.child('contributor_id').val() == auth.uid) ||
            (!data.exists() && newData.child('contributor_id').val() == auth.uid) ||
            root.child('admins').child(auth.uid).exists()
          )",
          
          ".read": "true",
          
          // ðŸ”’ CRITICAL: TTL enforcement + spoofing prevention
          ".validate": "
            newData.hasChildren(['lat', 'lng', 'timestamp', 'contributor_id', 'speed']) &&
            newData.child('lat').val() >= -90 && newData.child('lat').val() <= 90 &&
            newData.child('lng').val() >= -180 && newData.child('lng').val() <= 180 &&
            newData.child('speed').val() >= 0 && newData.child('speed').val() <= 120 && // Realistic bus speed
            newData.child('timestamp').val() > (now - 300000) && // 5-min TTL
            newData.child('timestamp').val() <= (now + 60000) && // Prevent future timestamps
            !root.child('users').child(newData.child('contributor_id').val()).child('isBanned').val()
          "
        }
      }
    },
    "admins": {
      ".read": "root.child('admins').child(auth.uid).exists()",
      ".write": "false" // Only set via Firebase Console
    },
    "users": {
      "$uid": {
        ".read": "auth != null && auth.uid == $uid",
        ".write": "auth != null && auth.uid == $uid",
        ".validate": "newData.child('trustScore').val() >= 0 && newData.child('trustScore').val() <= 100"
      }
    }
  }
}